{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/app/api/transcribe/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nexport const runtime = 'nodejs';\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    const form = await req.formData();\r\n    const file = form.get('file');\r\n    if (!file) return NextResponse.json({ error: 'No se recibió archivo' }, { status: 400 });\r\n\r\n    const OPENAI_API_KEY = process.env.OPENAI_API_KEY;\r\n    \r\n    if (!OPENAI_API_KEY) {\r\n      console.log('[transcribe] OPENAI_API_KEY: MISSING - usando transcripción local');\r\n      return NextResponse.json({\r\n        error: 'API de OpenAI no configurada. Por favor usa el botón de transcripción local en la interfaz.',\r\n        useLocal: true\r\n      }, { status: 400 });\r\n    }\r\n\r\n    console.log('[transcribe] Iniciando transcripción con OpenAI Whisper...');\r\n\r\n    // Convertir File a Blob/Buffer para reenviarlo\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    \r\n    console.log('[transcribe] Archivo recibido:', {\r\n      nombre: file.name,\r\n      tipo: file.type,\r\n      tamaño: buffer.length\r\n    });\r\n\r\n    // Crear FormData para OpenAI\r\n    const outbound = new FormData();\r\n    // OpenAI prefiere archivos con extensión correcta\r\n    const filename = file.name || 'audio.webm';\r\n    const blob = new Blob([buffer], { type: file.type || 'audio/webm' });\r\n    \r\n    outbound.append('file', blob, filename);\r\n    outbound.append('model', 'whisper-1');\r\n    outbound.append('language', 'es');\r\n\r\n    const resp = await fetch('https://api.openai.com/v1/audio/transcriptions', {\r\n      method: 'POST',\r\n      headers: {\r\n        Authorization: `Bearer ${OPENAI_API_KEY}`\r\n      },\r\n      body: outbound\r\n    });\r\n\r\n    if (!resp.ok) {\r\n      const errText = await resp.text();\r\n      console.error('[transcribe] Error de OpenAI:', {\r\n        status: resp.status,\r\n        statusText: resp.statusText,\r\n        error: errText\r\n      });\r\n      \r\n      return NextResponse.json({ \r\n        error: `Error de OpenAI (${resp.status}): ${errText}`,\r\n        useLocal: true,\r\n        suggestion: 'Intenta usar el botón \"Transcribir localmente\" en su lugar'\r\n      }, { status: resp.status });\r\n    }\r\n\r\n    const json = await resp.json();\r\n    console.log('[transcribe] Respuesta de OpenAI:', json);\r\n    \r\n    const transcript = json.text || json.transcript || '';\r\n\r\n    // Normalizar y contar palabras (quita signos de puntuación, normaliza diacríticos)\r\n    const cleaned = transcript\r\n      .normalize('NFD')\r\n      .replace(/\\p{Diacritic}/gu, '')\r\n      .replace(/[.,!?;:\\u2014\\-()\"'«»\\[\\]]+/g, ' ')\r\n      .toLowerCase();\r\n    const arr = cleaned.trim().split(/\\s+/).filter(Boolean);\r\n    const map = {};\r\n    arr.forEach(w => { map[w] = (map[w] || 0) + 1; });\r\n    const list = Object.entries(map).sort((a,b) => b[1] - a[1]);\r\n\r\n    return NextResponse.json({ transcript, total: arr.length, map, list });\r\n  } catch (err) {\r\n    console.error('API /transcribe error', err);\r\n    return NextResponse.json({ error: (err && err.message) ? err.message : String(err) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAEhB,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,QAAQ;QAC/B,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;QAEtF,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc;QAEjD,IAAI,CAAC,gBAAgB;YACnB,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,UAAU;YACZ,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,QAAQ,GAAG,CAAC;QAEZ,+CAA+C;QAC/C,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,OAAO,IAAI,CAAC;QAE3B,QAAQ,GAAG,CAAC,kCAAkC;YAC5C,QAAQ,KAAK,IAAI;YACjB,MAAM,KAAK,IAAI;YACf,QAAQ,OAAO,MAAM;QACvB;QAEA,6BAA6B;QAC7B,MAAM,WAAW,IAAI;QACrB,kDAAkD;QAClD,MAAM,WAAW,KAAK,IAAI,IAAI;QAC9B,MAAM,OAAO,IAAI,KAAK;YAAC;SAAO,EAAE;YAAE,MAAM,KAAK,IAAI,IAAI;QAAa;QAElE,SAAS,MAAM,CAAC,QAAQ,MAAM;QAC9B,SAAS,MAAM,CAAC,SAAS;QACzB,SAAS,MAAM,CAAC,YAAY;QAE5B,MAAM,OAAO,MAAM,MAAM,kDAAkD;YACzE,QAAQ;YACR,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,gBAAgB;YAC3C;YACA,MAAM;QACR;QAEA,IAAI,CAAC,KAAK,EAAE,EAAE;YACZ,MAAM,UAAU,MAAM,KAAK,IAAI;YAC/B,QAAQ,KAAK,CAAC,iCAAiC;gBAC7C,QAAQ,KAAK,MAAM;gBACnB,YAAY,KAAK,UAAU;gBAC3B,OAAO;YACT;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO,CAAC,iBAAiB,EAAE,KAAK,MAAM,CAAC,GAAG,EAAE,SAAS;gBACrD,UAAU;gBACV,YAAY;YACd,GAAG;gBAAE,QAAQ,KAAK,MAAM;YAAC;QAC3B;QAEA,MAAM,OAAO,MAAM,KAAK,IAAI;QAC5B,QAAQ,GAAG,CAAC,qCAAqC;QAEjD,MAAM,aAAa,KAAK,IAAI,IAAI,KAAK,UAAU,IAAI;QAEnD,mFAAmF;QACnF,MAAM,UAAU,WACb,SAAS,CAAC,OACV,OAAO,CAAC,mBAAmB,IAC3B,OAAO,CAAC,gCAAgC,KACxC,WAAW;QACd,MAAM,MAAM,QAAQ,IAAI,GAAG,KAAK,CAAC,OAAO,MAAM,CAAC;QAC/C,MAAM,MAAM,CAAC;QACb,IAAI,OAAO,CAAC,CAAA;YAAO,GAAG,CAAC,EAAE,GAAG,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,IAAI;QAAG;QAC/C,MAAM,OAAO,OAAO,OAAO,CAAC,KAAK,IAAI,CAAC,CAAC,GAAE,IAAM,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,EAAE;QAE1D,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;YAAY,OAAO,IAAI,MAAM;YAAE;YAAK;QAAK;IACtE,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,AAAC,OAAO,IAAI,OAAO,GAAI,IAAI,OAAO,GAAG,OAAO;QAAK,GAAG;YAAE,QAAQ;QAAI;IACtG;AACF"}}]
}