{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/util/pg.js"],"sourcesContent":["import { Pool } from 'pg';\r\n\r\n// Connection pool global (reutilizado entre requests)\r\nlet pool = null;\r\n\r\nexport function getPgPool() {\r\n  if (pool) {\r\n    return pool;\r\n  }\r\n\r\n  const preferred = process.env.POSTGRES_URL || process.env.DATABASE_URL || process.env.PG_CONNECTION_STRING;\r\n  const fallback = process.env.DIRECT_URL;\r\n\r\n  if (!preferred && !fallback) {\r\n    console.error('❌ ERROR: No hay cadena de conexión Postgres disponible');\r\n    throw new Error('POSTGRES_URL no está configurada');\r\n  }\r\n\r\n  const connectionString = preferred || fallback;\r\n  \r\n  pool = new Pool({\r\n    connectionString,\r\n    ssl: {\r\n      rejectUnauthorized: false\r\n    },\r\n    max: 20, // Máximo 20 conexiones en el pool\r\n    min: 2,  // Mínimo 2 conexiones siempre activas\r\n    idleTimeoutMillis: 30000, // Cerrar conexiones inactivas después de 30s\r\n    connectionTimeoutMillis: 5000, // Timeout de conexión: 5s\r\n    query_timeout: 10000, // Timeout de query: 10s\r\n  });\r\n\r\n  pool.on('error', (err) => {\r\n    console.error('❌ Error inesperado en pool de PostgreSQL:', err);\r\n  });\r\n\r\n  console.log('✅ Connection pool de PostgreSQL creado');\r\n  return pool;\r\n}\r\n\r\n// Función legacy para compatibilidad (ahora usa pool)\r\nexport async function getPgClient() {\r\n  const pool = getPgPool();\r\n  \r\n  try {\r\n    const client = await pool.connect();\r\n    \r\n    // Wrapper para mantener compatibilidad con código existente\r\n    return {\r\n      query: (...args) => client.query(...args),\r\n      end: () => client.release(), // Release al pool en lugar de cerrar\r\n      release: () => client.release()\r\n    };\r\n  } catch (error) {\r\n    console.error('❌ Error obteniendo cliente del pool:', error.message);\r\n    throw error;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAEA,sDAAsD;AACtD,IAAI,OAAO;AAEJ,SAAS;IACd,IAAI,MAAM;QACR,OAAO;IACT;IAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,oBAAoB;IAC1G,MAAM,WAAW,QAAQ,GAAG,CAAC,UAAU;IAEvC,IAAI,CAAC,aAAa,CAAC,UAAU;QAC3B,QAAQ,KAAK,CAAC;QACd,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,mBAAmB,aAAa;IAEtC,OAAO,IAAI,4GAAI,CAAC;QACd;QACA,KAAK;YACH,oBAAoB;QACtB;QACA,KAAK;QACL,KAAK;QACL,mBAAmB;QACnB,yBAAyB;QACzB,eAAe;IACjB;IAEA,KAAK,EAAE,CAAC,SAAS,CAAC;QAChB,QAAQ,KAAK,CAAC,6CAA6C;IAC7D;IAEA,QAAQ,GAAG,CAAC;IACZ,OAAO;AACT;AAGO,eAAe;IACpB,MAAM,OAAO;IAEb,IAAI;QACF,MAAM,SAAS,MAAM,KAAK,OAAO;QAEjC,4DAA4D;QAC5D,OAAO;YACL,OAAO,CAAC,GAAG,OAAS,OAAO,KAAK,IAAI;YACpC,KAAK,IAAM,OAAO,OAAO;YACzB,SAAS,IAAM,OAAO,OAAO;QAC/B;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC,MAAM,OAAO;QACnE,MAAM;IACR;AACF"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/util/cache.js"],"sourcesContent":["// util/cache.js\r\n/**\r\n * Sistema de caché simple en memoria para reducir latencia\r\n */\r\n\r\nclass SimpleCache {\r\n  constructor(ttl = 3600000) { // TTL por defecto: 1 hora\r\n    this.cache = new Map();\r\n    this.ttl = ttl;\r\n  }\r\n\r\n  set(key, value, customTtl = null) {\r\n    const expiresAt = Date.now() + (customTtl || this.ttl);\r\n    this.cache.set(key, { value, expiresAt });\r\n  }\r\n\r\n  get(key) {\r\n    const item = this.cache.get(key);\r\n    \r\n    if (!item) return null;\r\n    \r\n    // Verificar si expiró\r\n    if (Date.now() > item.expiresAt) {\r\n      this.cache.delete(key);\r\n      return null;\r\n    }\r\n    \r\n    return item.value;\r\n  }\r\n\r\n  has(key) {\r\n    return this.get(key) !== null;\r\n  }\r\n\r\n  delete(key) {\r\n    return this.cache.delete(key);\r\n  }\r\n\r\n  clear() {\r\n    this.cache.clear();\r\n  }\r\n\r\n  // Limpiar entradas expiradas\r\n  cleanup() {\r\n    const now = Date.now();\r\n    for (const [key, item] of this.cache.entries()) {\r\n      if (now > item.expiresAt) {\r\n        this.cache.delete(key);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Instancia global de caché\r\nconst globalCache = new SimpleCache();\r\n\r\n// Limpiar caché cada 5 minutos\r\nsetInterval(() => globalCache.cleanup(), 5 * 60 * 1000);\r\n\r\nexport default globalCache;\r\n"],"names":[],"mappings":"AAAA,gBAAgB;AAChB;;CAEC;;;;AAED,MAAM;IACJ,YAAY,MAAM,OAAO,CAAE;QACzB,IAAI,CAAC,KAAK,GAAG,IAAI;QACjB,IAAI,CAAC,GAAG,GAAG;IACb;IAEA,IAAI,GAAG,EAAE,KAAK,EAAE,YAAY,IAAI,EAAE;QAChC,MAAM,YAAY,KAAK,GAAG,KAAK,CAAC,aAAa,IAAI,CAAC,GAAG;QACrD,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK;YAAE;YAAO;QAAU;IACzC;IAEA,IAAI,GAAG,EAAE;QACP,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE5B,IAAI,CAAC,MAAM,OAAO;QAElB,sBAAsB;QACtB,IAAI,KAAK,GAAG,KAAK,KAAK,SAAS,EAAE;YAC/B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YAClB,OAAO;QACT;QAEA,OAAO,KAAK,KAAK;IACnB;IAEA,IAAI,GAAG,EAAE;QACP,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS;IAC3B;IAEA,OAAO,GAAG,EAAE;QACV,OAAO,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;IAC3B;IAEA,QAAQ;QACN,IAAI,CAAC,KAAK,CAAC,KAAK;IAClB;IAEA,6BAA6B;IAC7B,UAAU;QACR,MAAM,MAAM,KAAK,GAAG;QACpB,KAAK,MAAM,CAAC,KAAK,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,GAAI;YAC9C,IAAI,MAAM,KAAK,SAAS,EAAE;gBACxB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YACpB;QACF;IACF;AACF;AAEA,4BAA4B;AAC5B,MAAM,cAAc,IAAI;AAExB,+BAA+B;AAC/B,YAAY,IAAM,YAAY,OAAO,IAAI,IAAI,KAAK;uCAEnC"}},
    {"offset": {"line": 179, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/util/auth.js"],"sourcesContent":["import crypto from 'crypto';\r\nimport { getPgClient } from './pg';\r\nimport cache from './cache';\r\n\r\n// Session configuration\r\nconst SESSION_COOKIE_NAME = process.env.SESSION_COOKIE_NAME || 'fa_session';\r\nconst SESSION_MAX_AGE = process.env.SESSION_MAX_AGE ? parseInt(process.env.SESSION_MAX_AGE, 10) : 60 * 60 * 24 * 30; // 30 days in seconds\r\n\r\nexport async function createSession(userId) {\r\n\r\n  const token = crypto.randomBytes(48).toString('hex');\r\n  const expiresAt = new Date(Date.now() + SESSION_MAX_AGE * 1000);\r\n\r\n  const client = await getPgClient();\r\n  await client.query('INSERT INTO sessions (session_token, user_id, expires_at) VALUES ($1, $2, $3)', [token, userId, expiresAt]);\r\n  await client.end();\r\n\r\n  const isProd = process.env.NODE_ENV === 'production';\r\n  const cookieParts = [];\r\n  cookieParts.push(`${SESSION_COOKIE_NAME}=${token}`);\r\n  cookieParts.push(`Path=/`);\r\n  cookieParts.push(`HttpOnly`);\r\n  cookieParts.push(`SameSite=Strict`);\r\n  if (isProd) cookieParts.push(`Secure`);\r\n  cookieParts.push(`Max-Age=${SESSION_MAX_AGE}`);\r\n  cookieParts.push(`Expires=${expiresAt.toUTCString()}`);\r\n\r\n  const cookie = cookieParts.join('; ');\r\n  return { token, cookie };\r\n}\r\n\r\nexport async function clearSession(token) {\r\n  if (!token) return;\r\n  const client = await getPgClient();\r\n  await client.query('DELETE FROM sessions WHERE session_token = $1', [token]);\r\n  await client.end();\r\n}\r\n\r\nexport async function getUserFromRequest(req) {\r\n  try {\r\n    const cookieHeader = req.headers.get('cookie') || '';\r\n    const cookies = Object.fromEntries(cookieHeader.split(';').map(s => s.split('=').map(p => p && p.trim())));\r\n    const token = cookies[SESSION_COOKIE_NAME];\r\n    if (!token) return null;\r\n\r\n    // Verificar caché primero\r\n    const cacheKey = `session:${token}`;\r\n    const cachedUser = cache.get(cacheKey);\r\n    if (cachedUser) {\r\n      // Verificar que no haya expirado\r\n      if (new Date(cachedUser.expiresAt) > new Date()) {\r\n        return cachedUser.user;\r\n      }\r\n      cache.delete(cacheKey);\r\n    }\r\n\r\n    const client = await getPgClient();\r\n    const { rows } = await client.query(\r\n      `SELECT u.id, u.email, u.name, u.icon, u.phone, u.address, u.city, u.state, s.expires_at \r\n       FROM sessions s \r\n       JOIN users u ON s.user_id = u.id \r\n       WHERE s.session_token = $1 LIMIT 1`,\r\n      [token]\r\n    );\r\n    await client.end();\r\n\r\n    if (!rows || rows.length === 0) return null;\r\n    const row = rows[0];\r\n    const expires = new Date(row.expires_at);\r\n    if (expires < new Date()) {\r\n      // session expired\r\n      return null;\r\n    }\r\n\r\n    const user = { \r\n      id: row.id, \r\n      email: row.email, \r\n      name: row.name,\r\n      icon: row.icon,\r\n      phone: row.phone,\r\n      address: row.address,\r\n      city: row.city,\r\n      state: row.state\r\n    };\r\n\r\n    // Guardar en caché por 5 minutos\r\n    cache.set(cacheKey, { user, expiresAt: row.expires_at }, 5 * 60 * 1000);\r\n\r\n    return user;\r\n  } catch (err) {\r\n    console.error('getUserFromRequest error', err && err.message);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport { SESSION_COOKIE_NAME, SESSION_MAX_AGE };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 298, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/app/api/me/route.js"],"sourcesContent":["import { getUserFromRequest } from '../../../util/auth';\r\n\r\nexport const runtime = 'nodejs';\r\nexport const revalidate = 60; // Cache por 1 minuto\r\n\r\nexport async function GET(req) {\r\n  try {\r\n    const user = await getUserFromRequest(req);\r\n    \r\n    if (!user) {\r\n      return new Response(JSON.stringify({ error: 'No autenticado' }), { status: 401 });\r\n    }\r\n\r\n    return new Response(JSON.stringify({ user }), { status: 200 });\r\n  } catch (err) {\r\n    console.error('Get user error:', err && err.message);\r\n    return new Response(JSON.stringify({ error: 'Error interno del servidor' }), { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,aAAa,IAAI,qBAAqB;AAE5C,eAAe,IAAI,GAAG;IAC3B,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,oIAAkB,EAAC;QAEtC,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;gBAAE,OAAO;YAAiB,IAAI;gBAAE,QAAQ;YAAI;QACjF;QAEA,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE;QAAK,IAAI;YAAE,QAAQ;QAAI;IAC9D,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,mBAAmB,OAAO,IAAI,OAAO;QACnD,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,OAAO;QAA6B,IAAI;YAAE,QAAQ;QAAI;IAC7F;AACF"}}]
}