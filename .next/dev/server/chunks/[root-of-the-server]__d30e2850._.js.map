{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/util/supabase.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\n\r\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || '';\r\nconst SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_KEY || '';\r\n\r\nif (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {\r\n  // don't throw at import time in case some routes don't use supabase\r\n  console.warn('[supabase] SUPABASE_URL or SUPABASE_SERVICE_KEY not set');\r\n}\r\n\r\nexport function getSupabaseServerClient() {\r\n  if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {\r\n    throw new Error('Supabase config missing (SUPABASE_URL or SUPABASE_SERVICE_KEY)');\r\n  }\r\n  return createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {\r\n    // Use server-side settings if needed\r\n    auth: { persistSession: false },\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,eAAe,gFAAwC;AAC7D,MAAM,uBAAuB,QAAQ,GAAG,CAAC,oBAAoB,IAAI;AAEjE,IAAI,CAAC,gBAAgB,CAAC,sBAAsB;IAC1C,oEAAoE;IACpE,QAAQ,IAAI,CAAC;AACf;AAEO,SAAS;IACd,IAAI,CAAC,gBAAgB,CAAC,sBAAsB;QAC1C,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAA,yMAAY,EAAC,cAAc,sBAAsB;QACtD,qCAAqC;QACrC,MAAM;YAAE,gBAAgB;QAAM;IAChC;AACF"}},
    {"offset": {"line": 79, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/app/api/upload-to-supabase/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { getSupabaseServerClient } from '../../../util/supabase';\r\nimport crypto from 'crypto';\r\n\r\nexport const runtime = 'nodejs';\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    console.log('[upload-to-supabase] Iniciando proceso de upload...');\r\n    \r\n    const form = await req.formData();\r\n    const file = form.get('file');\r\n    \r\n    if (!file) {\r\n      console.error('[upload-to-supabase] No se recibió archivo en el FormData');\r\n      return NextResponse.json({ error: 'No se recibió archivo' }, { status: 400 });\r\n    }\r\n\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    const filename = file.name || 'audio.webm';\r\n    const mime = file.type || 'audio/webm';\r\n\r\n    console.log('[upload-to-supabase] Archivo recibido:', {\r\n      nombre: filename,\r\n      tamaño: buffer.length,\r\n      tipo: mime\r\n    });\r\n\r\n    const supabase = getSupabaseServerClient();\r\n    \r\n    // Verificar que Supabase esté configurado\r\n    if (!supabase) {\r\n      console.error('[upload-to-supabase] Cliente Supabase no inicializado');\r\n      return NextResponse.json({ error: 'Error de configuración de Supabase' }, { status: 500 });\r\n    }\r\n\r\n    // Use a deterministic path / folder\r\n    const id = crypto.randomUUID();\r\n    const path = `${id}_${filename}`;\r\n    \r\n    console.log('[upload-to-supabase] Intentando subir a bucket \"Audios\" con path:', path);\r\n\r\n    // Upload to bucket 'Audios' (con mayúscula, como está en Supabase)\r\n    const { data, error } = await supabase.storage.from('Audios').upload(path, buffer, {\r\n      contentType: mime,\r\n      upsert: false,\r\n    });\r\n\r\n    if (error) {\r\n      console.error('[upload-to-supabase] Error de Supabase Storage:', {\r\n        mensaje: error.message,\r\n        detalles: error,\r\n        statusCode: error.statusCode\r\n      });\r\n      return NextResponse.json({ \r\n        error: error.message || String(error),\r\n        detalles: 'Verifica que el bucket \"Audios\" existe y tiene políticas públicas configuradas'\r\n      }, { status: 500 });\r\n    }\r\n\r\n    console.log('[upload-to-supabase] Upload exitoso, data:', data);\r\n\r\n    // Get public URL (método correcto)\r\n    const { data: { publicUrl } } = supabase.storage.from('Audios').getPublicUrl(path);\r\n    \r\n    console.log('[upload-to-supabase] URL pública generada:', publicUrl);\r\n\r\n    // Obtener metadatos adicionales del FormData\r\n    const source = form.get('source') || 'daf';\r\n    const duration = parseFloat(form.get('duration')) || 0;\r\n    const wordCount = parseInt(form.get('wordCount')) || 0;\r\n    const transcript = form.get('transcript') || null;\r\n    const delayMs = parseInt(form.get('delay')) || null;\r\n    const playbackRate = parseFloat(form.get('playbackRate')) || 1.0;\r\n\r\n    // Calcular WPM\r\n    const wpm = duration > 0 ? Math.round((wordCount / duration) * 60) : 0;\r\n\r\n    // Guardar metadatos en la tabla de base de datos\r\n    const { data: dbData, error: dbError } = await supabase\r\n      .from('audios')\r\n      .insert({\r\n        id,\r\n        filename,\r\n        file_path: path,\r\n        file_url: publicUrl,\r\n        mime_type: mime,\r\n        file_size: buffer.length,\r\n        source,\r\n        duration,\r\n        word_count: wordCount,\r\n        wpm,\r\n        transcript,\r\n        delay_ms: delayMs,\r\n        playback_rate: playbackRate\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (dbError) {\r\n      console.error('[upload-to-supabase] Error al guardar en BD:', dbError);\r\n      // No fallar completamente si el archivo se subió pero falló la BD\r\n      return NextResponse.json({ \r\n        ok: true, \r\n        id, \r\n        path, \r\n        publicUrl,\r\n        warning: 'Archivo subido pero no se guardó en base de datos: ' + dbError.message\r\n      });\r\n    }\r\n\r\n    console.log('[upload-to-supabase] Metadatos guardados en BD:', dbData);\r\n\r\n    return NextResponse.json({ \r\n      ok: true, \r\n      id, \r\n      path, \r\n      publicUrl,\r\n      dbRecord: dbData\r\n    });\r\n  } catch (err) {\r\n    console.error('[upload-to-supabase] Error general:', err);\r\n    return NextResponse.json({ \r\n      error: (err && err.message) ? err.message : String(err),\r\n      stack: process.env.NODE_ENV === 'development' ? err.stack : undefined\r\n    }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}