{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/usuario/Documents/fluidez%20activa%20implementacion/app/api/transcribe_local/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport fs from 'fs/promises';\r\nimport os from 'os';\r\nimport path from 'path';\r\nimport { spawn } from 'child_process';\r\nimport Groq from 'groq-sdk';\r\n\r\nexport const runtime = 'nodejs';\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// This route tries to transcribe using a local `whisper` CLI tool (from openai-whisper)\r\n// Requirements: install Python and `pip install openai-whisper` (or faster-whisper), and ensure `whisper` is in PATH.\r\n\r\nexport async function POST(request) {\r\n  try {\r\n    const form = await req.formData();\r\n    const file = form.get('file');\r\n    if (!file) return NextResponse.json({ error: 'No se recibi贸 archivo' }, { status: 400 });\r\n\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    const filename = file.name || 'audio.webm';\r\n\r\n    // Save to temp file\r\n    const tmpDir = os.tmpdir();\r\n    const tmpFile = path.join(tmpDir, `${Date.now()}_${filename}`);\r\n    await fs.writeFile(tmpFile, buffer);\r\n\r\n    // Prepare output dir\r\n    const outDir = tmpDir; // whisper will write txt into this directory\r\n\r\n    // Execute whisper CLI: whisper <file> --language es --model small --output_format txt --output_dir <outDir>\r\n    // Note: the `whisper` CLI must be available in PATH.\r\n    const args = [tmpFile, '--language', 'es', '--model', 'small', '--output_format', 'txt', '--output_dir', outDir];\r\n\r\n    const whisper = spawn('whisper', args, { shell: true });\r\n\r\n    let stdout = '';\r\n    let stderr = '';\r\n    whisper.stdout.on('data', (d) => { stdout += d.toString(); });\r\n    whisper.stderr.on('data', (d) => { stderr += d.toString(); });\r\n\r\n    const exitCode = await new Promise((resolve) => {\r\n      whisper.on('close', resolve);\r\n      whisper.on('error', () => resolve(1));\r\n    });\r\n\r\n    if (exitCode !== 0) {\r\n      // Clean up temp file\r\n      try { await fs.unlink(tmpFile); } catch (e) {}\r\n      console.error('whisper cli failed', stderr);\r\n      return NextResponse.json({ error: 'Whisper CLI fall贸: ' + stderr }, { status: 500 });\r\n    }\r\n\r\n    // The CLI writes a file with same basename and .txt extension in outDir\r\n    const base = path.basename(tmpFile, path.extname(tmpFile));\r\n    const txtPath = path.join(outDir, `${base}.txt`);\r\n    let transcript = '';\r\n    try {\r\n      transcript = await fs.readFile(txtPath, 'utf8');\r\n    } catch (e) {\r\n      console.error('No se encontr贸 archivo de transcripci贸n', e);\r\n    }\r\n\r\n    // Clean up tmp files (audio + txt) - keep or remove based on needs\r\n    try { await fs.unlink(tmpFile); } catch (e) {}\r\n    try { await fs.unlink(txtPath); } catch (e) {}\r\n\r\n    return NextResponse.json({ ok: true, transcript, stdout, stderr });\r\n  } catch (err) {\r\n    console.error('API /transcribe_local error', err);\r\n    return NextResponse.json({ error: (err && err.message) ? err.message : String(err) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;;AAGO,MAAM,UAAU;AAChB,MAAM,UAAU;AAKhB,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,QAAQ;QAC/B,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;QAEtF,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,MAAM,WAAW,KAAK,IAAI,IAAI;QAE9B,oBAAoB;QACpB,MAAM,SAAS,wGAAE,CAAC,MAAM;QACxB,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,UAAU;QAC7D,MAAM,gIAAE,CAAC,SAAS,CAAC,SAAS;QAE5B,qBAAqB;QACrB,MAAM,SAAS,QAAQ,6CAA6C;QAEpE,4GAA4G;QAC5G,qDAAqD;QACrD,MAAM,OAAO;YAAC;YAAS;YAAc;YAAM;YAAW;YAAS;YAAmB;YAAO;YAAgB;SAAO;QAEhH,MAAM,UAAU,IAAA,4HAAK,EAAC,WAAW,MAAM;YAAE,OAAO;QAAK;QAErD,IAAI,SAAS;QACb,IAAI,SAAS;QACb,QAAQ,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;YAAQ,UAAU,EAAE,QAAQ;QAAI;QAC3D,QAAQ,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;YAAQ,UAAU,EAAE,QAAQ;QAAI;QAE3D,MAAM,WAAW,MAAM,IAAI,QAAQ,CAAC;YAClC,QAAQ,EAAE,CAAC,SAAS;YACpB,QAAQ,EAAE,CAAC,SAAS,IAAM,QAAQ;QACpC;QAEA,IAAI,aAAa,GAAG;YAClB,qBAAqB;YACrB,IAAI;gBAAE,MAAM,gIAAE,CAAC,MAAM,CAAC;YAAU,EAAE,OAAO,GAAG,CAAC;YAC7C,QAAQ,KAAK,CAAC,sBAAsB;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,wBAAwB;YAAO,GAAG;gBAAE,QAAQ;YAAI;QACpF;QAEA,wEAAwE;QACxE,MAAM,OAAO,4GAAI,CAAC,QAAQ,CAAC,SAAS,4GAAI,CAAC,OAAO,CAAC;QACjD,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,KAAK,IAAI,CAAC;QAC/C,IAAI,aAAa;QACjB,IAAI;YACF,aAAa,MAAM,gIAAE,CAAC,QAAQ,CAAC,SAAS;QAC1C,EAAE,OAAO,GAAG;YACV,QAAQ,KAAK,CAAC,2CAA2C;QAC3D;QAEA,mEAAmE;QACnE,IAAI;YAAE,MAAM,gIAAE,CAAC,MAAM,CAAC;QAAU,EAAE,OAAO,GAAG,CAAC;QAC7C,IAAI;YAAE,MAAM,gIAAE,CAAC,MAAM,CAAC;QAAU,EAAE,OAAO,GAAG,CAAC;QAE7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;YAAY;YAAQ;QAAO;IAClE,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,AAAC,OAAO,IAAI,OAAO,GAAI,IAAI,OAAO,GAAG,OAAO;QAAK,GAAG;YAAE,QAAQ;QAAI;IACtG;AACF"}}]
}